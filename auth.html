<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome | MONETRA</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="auth-body">
    <div class="auth-card-futuristic">
        <h1 id="form-title">Welcome Back</h1>
        <p id="form-subtitle">Login to continue your journey</p>
        
        <form id="auth-form">
            <!-- These fields are for Registration only, hidden by default -->
            <div class="input-group hidden-field" id="name-field">
                <input type="text" id="full-name-input" placeholder="Full Name">
            </div>
            <div class="input-group hidden-field" id="number-field">
                <input type="tel" id="number-input" placeholder="Mobile Number">
            </div>
            
            <!-- These fields are always visible -->
            <div class="input-group">
                <input type="email" id="email-input" placeholder="Email" required>
            </div>
            <div class="input-group">
                <input type="password" id="password-input" placeholder="Password" required>
            </div>
            
            <p class="error-message" id="error-message"></p>
            <button type="submit" id="submit-btn" class="auth-btn-futuristic">Login</button>
        </form>
        
        <p id="auth-switch-btn" class="auth-switch-futuristic">Don't have an account? <span>Register now</span></p>
    </div>

    <script>
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const formTitle = document.getElementById('form-title');
        const formSubtitle = document.getElementById('form-subtitle');
        const nameField = document.getElementById('name-field');
        const numberField = document.getElementById('number-field');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const fullNameInput = document.getElementById('full-name-input');
        const numberInput = document.getElementById('number-input');
        const submitBtn = document.getElementById('submit-btn');
        const authSwitchBtn = document.getElementById('auth-switch-btn');
        const errorMessage = document.getElementById('error-message');

        let isLoginMode = true;

        // Function to toggle between Login and Register modes
        authSwitchBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            errorMessage.textContent = ''; // Clear errors on switch

            if (isLoginMode) {
                // Switch to LOGIN mode
                formTitle.textContent = 'Welcome Back';
                formSubtitle.textContent = 'Login to continue your journey';
                nameField.classList.remove('visible-field');
                numberField.classList.remove('visible-field');
                nameField.classList.add('hidden-field');
                numberField.classList.add('hidden-field');
                submitBtn.textContent = 'Login';
                authSwitchBtn.innerHTML = "Don't have an account? <span>Register now</span>";
            } else {
                // Switch to REGISTER mode
                formTitle.textContent = 'Create Your Account';
                formSubtitle.textContent = 'Join us and start earning';
                nameField.classList.remove('hidden-field');
                numberField.classList.remove('hidden-field');
                nameField.classList.add('visible-field');
                numberField.classList.add('visible-field');
                submitBtn.textContent = 'Create Account';
                authSwitchBtn.innerHTML = "Already have an account? <span>Login</span>";
            }
        });

        // Handle Form Submission
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const fullName = fullNameInput.value;
            const mobileNumber = numberInput.value;
            errorMessage.textContent = '';

            if (isLoginMode) {
                // Login Logic
                auth.signInWithEmailAndPassword(email, password)
                    .then(userCred => { window.location.href = 'index.html'; })
                    .catch(err => { errorMessage.textContent = err.message; });
            } else {
                // Register Logic
                if (fullName.trim() === '' || mobileNumber.trim() === '') {
                    errorMessage.textContent = "Please fill in all fields.";
                    return;
                }
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCred => {
                        const user = userCred.user;
                        // 1. Update the Auth profile display name
                        return user.updateProfile({
                            displayName: fullName
                        }).then(() => {
                            // 2. Save all info to Firestore
                            return db.collection('users').doc(user.uid).set({
                                name: fullName,
                                email: user.email,
                                phone: mobileNumber,
                                walletBalance: 0,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                    })
                    .then(() => {
                        // 3. Redirect to home page after everything is saved
                        window.location.href = 'index.html';
                    })
                    .catch(err => { errorMessage.textContent = err.message; });
            }
        });
    </script>
</body>
</html>
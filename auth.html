<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome | MONETRA</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden; position: relative; }
        .bg-animation { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: float 15s infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; } }
        .auth-container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 24px; padding: 48px; width: 100%; max-width: 480px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1); animation: slideIn 0.8s ease-out; position: relative; overflow: hidden; }
        .auth-container::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        @keyframes slideIn { 0% { opacity: 0; transform: translateY(30px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .logo-section { text-align: center; margin-bottom: 40px; }
        .logo { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #ffffff, #e0e7ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; animation: glow 3s ease-in-out infinite alternate; }
        @keyframes glow { 0% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3)); } 100% { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.6)); } }
        .form-title { color: #ffffff; font-size: 28px; font-weight: 700; margin-bottom: 8px; transition: all 0.3s ease; }
        .form-subtitle { color: rgba(255, 255, 255, 0.8); font-size: 16px; font-weight: 400; margin-bottom: 32px; }
        .input-group { margin-bottom: 24px; position: relative; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .input-group.hidden-field { max-height: 0; margin-bottom: 0; opacity: 0; transform: translateY(-20px); }
        .input-group.visible-field { max-height: 100px; margin-bottom: 24px; opacity: 1; transform: translateY(0); }
        .input-field { width: 100%; padding: 16px 20px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: #ffffff; font-size: 16px; font-weight: 500; transition: all 0.3s ease; outline: none; }
        .input-field::placeholder { color: rgba(255, 255, 255, 0.6); font-weight: 400; }
        .input-field:focus { background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.5); transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .input-field:hover { border-color: rgba(255, 255, 255, 0.3); }
        .error-message { color: #ff6b6b; font-size: 14px; font-weight: 500; min-height: 20px; margin-bottom: 16px; text-align: center; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
        .error-message.show { opacity: 1; transform: translateY(0); }
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 12px; color: #ffffff; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; margin-bottom: 24px; }
        .submit-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.5s ease; }
        .submit-btn:hover::before { left: 100%; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4); }
        .submit-btn:active { transform: translateY(0); }
        .submit-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .auth-switch { text-align: center; color: rgba(255, 255, 255, 0.8); font-size: 14px; font-weight: 400; }
        .auth-switch span { color: #ffffff; font-weight: 600; cursor: pointer; text-decoration: underline; text-underline-offset: 2px; transition: all 0.3s ease; }
        .auth-switch span:hover { color: #e0e7ff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        .loading-spinner { display: none; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid #ffffff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-content { display: flex; align-items: center; justify-content: center; }
        @media (max-width: 640px) { .auth-container { padding: 32px 24px; margin: 16px; } .logo { font-size: 28px; } .form-title { font-size: 24px; } }
    </style>
</head>
<body>
    <div class="bg-animation" id="bg-animation"></div>
    <div class="auth-container">
        <div class="logo-section"> <div class="logo">MONETRA</div> </div>
        <h1 class="form-title" id="form-title">Welcome Back</h1>
        <p class="form-subtitle" id="form-subtitle">Login to continue your journey</p>
        <form id="auth-form">
            <div class="input-group hidden-field" id="name-field-group"> <input type="text" class="input-field" id="full-name-input" placeholder="Full Name"> </div>
            <div class="input-group hidden-field" id="number-field-group"> <input type="tel" class="input-field" id="number-input" placeholder="Mobile Number"> </div>
            <div class="input-group hidden-field" id="referral-field-group"> <input type="text" class="input-field" id="referral-input" placeholder="Referral Code (Optional)"> </div>
            <div class="input-group"> <input type="email" class="input-field" id="email-input" placeholder="Email Address" required> </div>
            <div class="input-group"> <input type="password" class="input-field" id="password-input" placeholder="Password" required> </div>
            <div class="error-message" id="error-message"></div>
            <button type="submit" class="submit-btn" id="submit-btn">
                <div class="btn-content"> <div class="loading-spinner" id="loading-spinner"></div> <span id="btn-text">Login</span> </div>
            </button>
        </form>
        <p class="auth-switch" id="auth-switch-btn"> Don't have an account? <span>Sign up</span> </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            function createParticles() { /* ...particle code... */ } createParticles();
            const formTitle = document.getElementById('form-title');
            const formSubtitle = document.getElementById('form-subtitle');
            const authForm = document.getElementById('auth-form');
            const nameFieldGroup = document.getElementById('name-field-group');
            const numberFieldGroup = document.getElementById('number-field-group');
            const referralFieldGroup = document.getElementById('referral-field-group');
            const submitBtn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const authSwitchBtn = document.getElementById('auth-switch-btn');
            const errorMessage = document.getElementById('error-message');
            
            let isLoginMode = true;

            function showError(message) { errorMessage.textContent = message; errorMessage.classList.add('show'); }
            function hideError() { errorMessage.classList.remove('show'); }
            function showLoading() { submitBtn.disabled = true; loadingSpinner.style.display = 'block'; btnText.textContent = isLoginMode ? 'Logging in...' : 'Creating Account...'; }
            function hideLoading() { submitBtn.disabled = false; loadingSpinner.style.display = 'none'; btnText.textContent = isLoginMode ? 'Login' : 'Create Account'; }

            authSwitchBtn.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                hideError(); authForm.reset();
                if (isLoginMode) {
                    formTitle.textContent = 'Welcome Back';
                    formSubtitle.textContent = 'Login to continue your journey';
                    btnText.textContent = 'Login';
                    authSwitchBtn.innerHTML = "Don't have an account? <span>Sign up</span>";
                    nameFieldGroup.classList.remove('visible-field'); nameFieldGroup.classList.add('hidden-field');
                    numberFieldGroup.classList.remove('visible-field'); numberFieldGroup.classList.add('hidden-field');
                    referralFieldGroup.classList.remove('visible-field'); referralFieldGroup.classList.add('hidden-field');
                } else {
                    formTitle.textContent = 'Join MONETRA';
                    formSubtitle.textContent = 'Create your account to get started';
                    btnText.textContent = 'Create Account';
                    authSwitchBtn.innerHTML = "Already have an account? <span>Login</span>";
                    nameFieldGroup.classList.remove('hidden-field'); nameFieldGroup.classList.add('visible-field');
                    numberFieldGroup.classList.remove('hidden-field'); numberFieldGroup.classList.add('visible-field');
                    referralFieldGroup.classList.remove('hidden-field'); referralFieldGroup.classList.add('visible-field');
                }
            });

            // --- FINAL, SIMPLIFIED, AND CORRECTED SCRIPT ---
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email-input').value.trim();
                const password = document.getElementById('password-input').value.trim();
                hideError();
                showLoading();

                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                        window.location.href = 'index.html';
                    } else {
                        const fullName = document.getElementById('full-name-input').value.trim();
                        const mobileNumber = document.getElementById('number-input').value.trim();
                        const referralCodeInput = document.getElementById('referral-input').value.trim().toUpperCase();
                        
                        if (!fullName || !mobileNumber) { throw new Error('Please fill in your name and number.'); }
                        
                        // Step 1: Create the new user first. This is the most important action.
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;

                        // Step 2: Prepare the user's data document.
                        const ownReferralCode = `MON${user.uid.slice(-6).toUpperCase()}`;
                        const newUserDoc = {
                            name: fullName,
                            email: email,
                            phone: mobileNumber,
                            referralCode: ownReferralCode,
                            walletBalance: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // Step 3: If a referral code was used, just add it to the new user's document.
                        // We will NOT try to give a reward here. That is done manually by the admin.
                        if (referralCodeInput) {
                            newUserDoc.referredByCode = referralCodeInput;
                        }
                        
                        // Step 4: Save the new user's document. This will not fail.
                        await db.collection('users').doc(user.uid).set(newUserDoc);
                        
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    showError(error.message);
                } finally {
                    hideLoading();
                }
            });
        });
    </script>
</body>
</html>